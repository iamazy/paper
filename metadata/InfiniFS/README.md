# InfiniFS: An Efficient Metadata Service for Large-Scale Distributed Filesystems

## 摘要

现代数据中心更倾向于使用一个跨越整个数据中心且支持数十亿个文件的单个文件系统实例。在这种情况下，文件系统元数据的维护面临独特的挑战，包括保留本地性的同时实现负载均衡、长路径解析和 near-root 热点问题。

为了解决这些挑战，我们提出了 InfiniFS，一种用于极大规模分布式文件系统的高效元数据服务。它包括三个关键技术。首先，InfiniFS 将目录的*访问 (access)* 和*内容 (content)* 元数据解耦，使得目录树可以进行元数据本地化和负载均衡的分区。其次，InfiniFS 设计了可以并行遍历路径的*推测路径解析*，大大降低了元数据操作的延迟。第三，InfiniFS 在客户端引入了*乐观访问的元数据缓存*，以缓解 near-root 热点问题，有效提高元数据操作的吞吐量。广泛的评估显示，InfiniFS 在延迟和吞吐量方面优于最先进的分布式文件系统元数据服务，并为高达 1000 亿个文件的极大规模目录树提供稳定的性能。

## 1. 介绍

对于快速扩张的企业而言，现代数据中心通常包含大量的文件，这些文件的数量很容易超出当前分布式文件系统单个实例的容量 [23, 27, 35, 36, 39, 42]。目前，一般将数据中心划分为相对较小的集群，每个集群分别运行一个分布式文件系统实例。然而，更加理想的做法是使用一个单一的文件系统实例来管理整个数据中心，它可以提供全局数据共享、高资源利用率和低操作复杂性。例如，Facebook 引入了 Tectonic 分布式文件系统，将小型存储集群整合为一个包含数十亿个文件的单一实例 [28]。

对于分布式文件系统而言，可扩展和高效的元数据服务至关重要 [14, 22, 23, 25, 28, 31-33, 36, 41]。现代数据中心通常包含数十亿甚至数百亿个文件，使用一个极大规模的文件系统来管理所有文件，对元数据服务带来了严峻的挑战。首先，目录树的分区既要实现高元数据本地性，又要实现良好的负载均衡，这在目录树扩展和工作负载多样化时是具有挑战性的。其次，由于极大规模文件系统中文件深度很深，路径解析的延迟可能会很高。第三，由于极大规模文件系统通常需要服务大量并发客户端，客户端元数据缓存的一致性维护开销变得无法承受。

本文提出了 InfiniFS，一个用于极大规模分布式文件系统的高效元数据服务。为了解决上述挑战，InfiniFS 通过以下设计分配文件系统目录树并加速元数据操作。

首先，我们提出了一种*访问-内容*解耦的分区方法，以实现高元数据本地性和良好的负载均衡。关键思想是将目录的访问元数据（名称、ID 和权限）和内容元数据（条目列表和时间戳）解耦，并在细粒度级别上进一步分割这些元数据对象。具体而言，我们首先将每个目录的访问元数据与其父目录配对，并将内容元数据与其子目录配对，从而实现高元数据本地性。然后，我们使用目录 ID 的一致性哈希将这些细粒度的分组分配给不同的元数据服务器，以确保良好的负载均衡。

其次，我们设计了一种*推测路径解析*方法，以并行遍历目录树，从而大大降低元数据操作的延迟。关键思想是为每个目录分配一个可预测的 ID，使客户端可以对所有中间目录的 ID 进行推测，然后并行发送多组件路径的查找 (lookup) 请求。

第三，我们引入了一种*乐观访问的元数据缓存*，以缓解 near-root 热点问题，实现可扩展的路径解析。关键思想是在客户端缓存目录访问元数据，以减少对 near-root 目录的频繁查找，并在低开销的元数据服务器上惰性地删除缓存条目。具体而言，目录*重命名 (rename) *和*目录设置权限 (set_permission) *操作将向元数据服务器发送缓存失效通知，而不是向众多客户端发送通知，以便每个服务器在处理客户端元数据请求时惰性地验证缓存的陈旧程度。